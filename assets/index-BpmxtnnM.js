(function(){const o=document.createElement("link").relList;if(o&&o.supports&&o.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))t(s);new MutationObserver(s=>{for(const a of s)if(a.type==="childList")for(const i of a.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&t(i)}).observe(document,{childList:!0,subtree:!0});function n(s){const a={};return s.integrity&&(a.integrity=s.integrity),s.referrerPolicy&&(a.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?a.credentials="include":s.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function t(s){if(s.ep)return;s.ep=!0;const a=n(s);fetch(s.href,a)}})();let h=null,w=null;const v=document.querySelector("#toc"),b=document.querySelector("#book-content"),E=document.querySelector("#chapter-title"),g=document.querySelector("#sidebar"),T=document.querySelector("#sidebar-toggle");async function x(){try{localStorage.getItem("sidebarCollapsed")==="true"&&g.classList.add("collapsed"),T.addEventListener("click",()=>{g.classList.toggle("collapsed"),window.innerWidth<=768&&g.classList.toggle("active"),localStorage.setItem("sidebarCollapsed",g.classList.contains("collapsed"))});const o=document.getElementById("collapse-all-btn");if(o&&o.addEventListener("click",t=>{t.stopPropagation(),v.querySelectorAll(".expanded").forEach(a=>a.classList.remove("expanded"))}),h=await(await fetch("data/library.json?v="+Date.now())).json(),M(),h.books&&h.books.length>0){const t=h.books[0];t.chapters.length>0&&y(t,t.chapters[0].id)}}catch(e){console.error("Failed to initialize app:",e),b&&(b.innerHTML='<p class="error">Failed to load content. Please check console.</p>')}}function M(){v&&(v.innerHTML="",h.books&&h.books.forEach(e=>{const o=document.createElement("div");o.className="book-group";const n=document.createElement("div");n.className="book-header";const t='<svg class="book-icon" viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg>';n.innerHTML=`${t} <h2 class="book-title-text">${e.title}</h2>`,n.onclick=()=>{o.classList.toggle("expanded")},o.appendChild(n);const s=document.createElement("div");s.className="book-chapters",e.chapters.forEach((a,i)=>{const c=document.createElement("div");c.className="sidebar-item chapter-link",c.dataset.id=a.id;const f=`${i+1}.`,$=a.title,u=document.createElement("div");if(u.className="chapter-header",u.innerHTML=`<h3><span class="ch-num">${f}</span> <span>${$}</span></h3>`,u.onclick=p=>{const d=c.classList.contains("expanded");s.querySelectorAll(".sidebar-item").forEach(r=>r.classList.remove("expanded")),d||c.classList.add("expanded")},c.appendChild(u),a.sections){const p=document.createElement("ul");p.className="chapter-sections",a.sections.forEach(d=>{const r=document.createElement("li");r.className="section-link",r.dataset.id=d.id;const l=d.title.match(/^(§\s*\d+\.\d+\.?)\s*(.*)$/),k=l?l[1]:d.id.includes("problems")?"?":"",C=l?l[2]:d.title;r.innerHTML=`<span class="sec-num">${k}</span><span class="sec-title">${C}</span>`,r.onclick=S=>{S.stopPropagation(),y(e,a.id,d.id),window.innerWidth<=768&&g.classList.remove("active")},p.appendChild(r)}),c.appendChild(p)}s.appendChild(c)}),o.appendChild(s),v.appendChild(o),h.books.indexOf(e)===0&&o.classList.add("expanded")}))}async function y(e,o,n=null){try{const t=e.chapters.find(c=>c.id===o);if(!t)return;let s=null;if(t.folder&&n){const c=t.sections.find(f=>f.id===n);c&&c.file&&(s=`data/${t.folder}/${c.file}`)}else if(t.file)s=`data/chapters/${t.file}`;else if(t.folder&&!n&&t.sections.length>0){const c=t.sections[0];s=`data/${t.folder}/${c.file}`,n=c.id}if(!s){console.warn("No file content mapped for this section."),n&&alert("Энэ хэсгийн агуулга одоогоор бэлэн болоогүй байна.");return}document.getElementById("book-content").className="";const i=await(await fetch(s)).json();w={...t,...i},H(i),N(o,n),setTimeout(()=>{window.scrollTo({top:0,behavior:"smooth"}),window.MathJax&&window.MathJax.typesetPromise()},100)}catch(t){console.error("Failed to load chapter:",t)}}function N(e,o){document.querySelectorAll(".section-link").forEach(t=>t.classList.remove("active")),document.querySelectorAll(".sidebar-item").forEach(t=>t.classList.remove("active-chapter"));const n=document.querySelector(`.sidebar-item[data-id="${e}"]`);if(n&&(n.classList.add("active-chapter"),n.classList.add("expanded")),o){const t=n?n.querySelector(`.section-link[data-id="${o}"]`):null;t&&t.classList.add("active")}}function H(e){b&&(E&&(E.textContent=e.title),b.innerHTML="",e.body.forEach(o=>{const n=L(o);n&&b.appendChild(n)}))}function L(e){switch(e.type){case"text":const o=document.createElement("p");return(e.value.includes("Бодолт")||e.value.trim().startsWith("<b>Бодолт")||e.value.includes("Шийдэл")||e.value.trim().startsWith("<b>Шийдэл"))&&(o.className="solution-text"),o.innerHTML=m(e.value),o;case"header":const n=document.createElement("h2");return e.id&&(n.id=e.id),n.textContent=e.value,n;case"note":const t=document.createElement("div");return t.className="note-box",t.innerHTML=m(e.value),t;case"problem":const s=document.createElement("div");s.className="problem-container";let a=`<div class="problem-header"><strong>${e.number}. ${e.title}</strong></div>`;if(a+=`<div class="problem-statement">${m(e.statement)}</div>`,e.image){const r=e.image.src.startsWith("images/")||e.image.src.startsWith("/")?e.image.src:`images/${e.image.src}`,l=r.startsWith("/")?r.substring(1):r;a+=`
          <div class="image-container">
            <img src="${l}" alt="${e.image.caption||""}">
            ${e.image.caption?`<p class="caption">${e.image.caption}</p>`:""}
          </div>
        `}return e.solution&&(a+=`<div class="problem-solution"><strong>Бодолт:</strong> ${m(e.solution)}</div>`),s.innerHTML=a,s;case"section":const i=document.createElement("section");return i.id=e.id,i.innerHTML=`<h2>${e.title}</h2>`,e.body.forEach(r=>{const l=L(r);l&&i.appendChild(l)}),i;case"subsection":const c=document.createElement("div");return c.className="subsection",c.innerHTML=`<h3>${e.title}</h3>`,e.body.forEach(r=>{const l=L(r);l&&c.appendChild(l)}),c;case"equation":const f=document.createElement("div");f.className="equation-wrapper";const $=e.tag?`<span class="equation-tag">(${e.tag})</span>`:"";return f.innerHTML=`\\[ ${e.value} \\] ${$}`,f;case"image":const u=document.createElement("div");u.className="image-container";const p=e.src.startsWith("images/")||e.src.startsWith("/")?e.src:`images/${e.src}`,d=p.startsWith("/")?p.substring(1):p;return u.innerHTML=`
        <img src="${d}" alt="${e.caption||""}">
        ${e.caption?`<p class="caption">${e.caption}</p>`:""}
      `,u;default:return null}}function m(e){return e?e.replace(/\$\$(.+?)\$\$/gs,(n,t)=>`\\[${t}\\]`).replace(/\$([^$]+)\$/g,(n,t)=>`\\(${t.trim()}\\)`):""}x();
